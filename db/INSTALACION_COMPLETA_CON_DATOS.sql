/* ================================================================
   INSTALACIรN COMPLETA CON DATOS DE DEMOSTRACIรN
   Sistema de Gestiรณn de Residencias para NNA
   ================================================================
   
   Este script crea e inicializa TODO el sistema listo para usar:
   
   โ Base de datos completa
   โ Todas las tablas (Niรฑo, Tutor, Legajo, Alerta, Usuario, etc.)
   โ Vistas optimizadas
   โ Stored Procedures
   โ รndices para rendimiento
   โ Catรกlogos con datos iniciales
   โ Usuario administrador (admin / Admin123!)
   โ Datos de demostraciรณn (5 tutores, 10 niรฑos, 10 legajos, 20 alertas)
   
   EJECUTAR ESTE SCRIPT UNA SOLA VEZ
   
   Fecha: Octubre 2025
   Versiรณn: 1.0
   ================================================================ */

USE master;
GO

-- Configurar para mostrar mensajes informativos
SET NOCOUNT OFF;
GO

PRINT ''
PRINT '================================================================'
PRINT '  ๐ INSTALACIรN COMPLETA - SISTEMA RESIDENCIAS NNA'
PRINT '================================================================'
PRINT ''
PRINT '๐ Fecha de ejecuciรณn: ' + CONVERT(VARCHAR, GETDATE(), 120)
PRINT ''
PRINT 'โฑ๏ธ Tiempo estimado: 30-60 segundos'
PRINT ''

/*================================================================
  PASO 1: RECREAR BASE DE DATOS
  ================================================================*/
PRINT ''
PRINT 'โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ'
PRINT '  PASO 1/7: CREANDO BASE DE DATOS'
PRINT 'โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ'
PRINT ''

IF DB_ID('ResidenciaDB') IS NOT NULL
BEGIN
    PRINT '๐๏ธ Eliminando base de datos existente...'
    ALTER DATABASE ResidenciaDB SET SINGLE_USER WITH ROLLBACK IMMEDIATE;
    DROP DATABASE ResidenciaDB;
    PRINT '   โ Base de datos anterior eliminada'
END

PRINT '๐ Creando nueva base de datos...'
CREATE DATABASE ResidenciaDB;
PRINT '   โ ResidenciaDB creada exitosamente'
PRINT ''
GO

USE ResidenciaDB;
GO

SET ANSI_NULLS ON;
SET QUOTED_IDENTIFIER ON;
GO

/*================================================================
  PASO 2: CREAR TABLAS PRINCIPALES
  ================================================================*/
PRINT ''
PRINT 'โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ'
PRINT '  PASO 2/7: CREANDO TABLAS PRINCIPALES'
PRINT 'โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ'
PRINT ''

-- Tabla Nino
CREATE TABLE dbo.Nino (
  Id                INT IDENTITY(1,1) PRIMARY KEY,
  Dni               VARCHAR(20) NOT NULL,
  Apellido          NVARCHAR(100) NOT NULL,
  Nombre            NVARCHAR(100) NOT NULL,
  FechaNacimiento   DATE NOT NULL,
  FechaCreacion     DATETIME2 NOT NULL DEFAULT SYSDATETIME(),
  FechaModificacion DATETIME2 NOT NULL DEFAULT SYSDATETIME(),
  UsuarioCreacion   NVARCHAR(100) NULL,
  UsuarioModificacion NVARCHAR(100) NULL,
  CONSTRAINT UQ_Nino_Dni UNIQUE (Dni)
);
PRINT '   โ Tabla Nino'

-- Tabla Tutor
CREATE TABLE dbo.Tutor (
  Id                INT IDENTITY(1,1) PRIMARY KEY,
  Nombre            NVARCHAR(100) NOT NULL,
  Apellido          NVARCHAR(100) NULL,
  Telefono          NVARCHAR(50) NULL,
  Email             NVARCHAR(100) NULL,
  FechaCreacion     DATETIME2 NOT NULL DEFAULT SYSDATETIME(),
  FechaModificacion DATETIME2 NOT NULL DEFAULT SYSDATETIME(),
  UsuarioCreacion   NVARCHAR(100) NULL,
  UsuarioModificacion NVARCHAR(100) NULL
);
PRINT '   โ Tabla Tutor'

-- Tabla Estado
CREATE TABLE dbo.Estado (
  Id          INT IDENTITY(1,1) PRIMARY KEY,
  Nombre      NVARCHAR(50) NOT NULL,
  Descripcion NVARCHAR(200) NULL
);
PRINT '   โ Tabla Estado'

-- Tabla TipoAlerta
CREATE TABLE dbo.TipoAlerta (
  Id          INT IDENTITY(1,1) PRIMARY KEY,
  Nombre      NVARCHAR(50) NOT NULL,
  Descripcion NVARCHAR(100) NULL
);
PRINT '   โ Tabla TipoAlerta'

-- Tabla Prioridad
CREATE TABLE dbo.Prioridad (
  Id     INT IDENTITY(1,1) PRIMARY KEY,
  Nombre NVARCHAR(50) NOT NULL,
  Color  VARCHAR(7) NULL,
  Orden  INT NULL
);
PRINT '   โ Tabla Prioridad'

-- Tabla EstadoAlerta
CREATE TABLE dbo.EstadoAlerta (
  Id          INT IDENTITY(1,1) PRIMARY KEY,
  Nombre      NVARCHAR(50) NOT NULL,
  Descripcion NVARCHAR(100) NULL
);
PRINT '   โ Tabla EstadoAlerta'

-- Tabla Legajo
CREATE TABLE dbo.Legajo (
  Id                INT IDENTITY(1,1) PRIMARY KEY,
  NinoId            INT NOT NULL,
  TutorId           INT NULL,
  EstadoId          INT NOT NULL,
  FechaIngreso      DATE NOT NULL,
  FechaEgreso       DATE NULL,
  Observaciones     NVARCHAR(500) NULL,
  FechaCreacion     DATETIME2 NOT NULL DEFAULT SYSDATETIME(),
  FechaModificacion DATETIME2 NOT NULL DEFAULT SYSDATETIME(),
  UsuarioCreacion   NVARCHAR(100) NULL,
  UsuarioModificacion NVARCHAR(100) NULL,
  CONSTRAINT FK_Legajo_Nino   FOREIGN KEY (NinoId) REFERENCES dbo.Nino(Id),
  CONSTRAINT FK_Legajo_Tutor  FOREIGN KEY (TutorId) REFERENCES dbo.Tutor(Id),
  CONSTRAINT FK_Legajo_Estado FOREIGN KEY (EstadoId) REFERENCES dbo.Estado(Id)
);
PRINT '   โ Tabla Legajo'

-- Tabla Alerta
CREATE TABLE dbo.Alerta (
  Id                INT IDENTITY(1,1) PRIMARY KEY,
  TipoId            INT NOT NULL,
  PrioridadId       INT NOT NULL,
  EstadoId          INT NOT NULL,
  LegajoId          INT NOT NULL,
  Descripcion       NVARCHAR(500) NOT NULL,
  FechaVencimiento  DATETIME2 NOT NULL,
  FechaCreacion     DATETIME2 NOT NULL DEFAULT SYSDATETIME(),
  FechaModificacion DATETIME2 NOT NULL DEFAULT SYSDATETIME(),
  UsuarioCreacion   NVARCHAR(100) NULL,
  UsuarioModificacion NVARCHAR(100) NULL,
  CONSTRAINT FK_Alerta_Tipo       FOREIGN KEY (TipoId) REFERENCES dbo.TipoAlerta(Id),
  CONSTRAINT FK_Alerta_Prioridad  FOREIGN KEY (PrioridadId) REFERENCES dbo.Prioridad(Id),
  CONSTRAINT FK_Alerta_Estado     FOREIGN KEY (EstadoId) REFERENCES dbo.EstadoAlerta(Id),
  CONSTRAINT FK_Alerta_Legajo     FOREIGN KEY (LegajoId) REFERENCES dbo.Legajo(Id)
);
PRINT '   โ Tabla Alerta'

-- Tablas de Autenticaciรณn
CREATE TABLE dbo.Rol (
    Id INT IDENTITY(1,1) PRIMARY KEY,
    Nombre NVARCHAR(50) NOT NULL UNIQUE,
    Descripcion NVARCHAR(200) NULL,
    Nivel INT NOT NULL DEFAULT 3,
    FechaCreacion DATETIME2 NOT NULL DEFAULT SYSDATETIME()
);
PRINT '   โ Tabla Rol'

CREATE TABLE dbo.Usuario (
    Id INT IDENTITY(1,1) PRIMARY KEY,
    Usuario NVARCHAR(50) NOT NULL UNIQUE,
    PasswordHash NVARCHAR(500) NOT NULL,
    Salt NVARCHAR(500) NOT NULL,
    Email NVARCHAR(100) NOT NULL UNIQUE,
    NombreCompleto NVARCHAR(200) NOT NULL,
    RolId INT NOT NULL,
    Activo BIT NOT NULL DEFAULT 1,
    IntentosLogin INT NOT NULL DEFAULT 0,
    UltimoIntento DATETIME2 NULL,
    UltimoAcceso DATETIME2 NULL,
    FechaCreacion DATETIME2 NOT NULL DEFAULT SYSDATETIME(),
    FechaModificacion DATETIME2 NOT NULL DEFAULT SYSDATETIME(),
    CONSTRAINT FK_Usuario_Rol FOREIGN KEY (RolId) REFERENCES dbo.Rol(Id)
);
PRINT '   โ Tabla Usuario'

CREATE TABLE dbo.Sesion (
    Id INT IDENTITY(1,1) PRIMARY KEY,
    UsuarioId INT NOT NULL,
    Token NVARCHAR(500) NOT NULL UNIQUE,
    FechaCreacion DATETIME2 NOT NULL DEFAULT SYSDATETIME(),
    FechaExpiracion DATETIME2 NOT NULL,
    Activa BIT NOT NULL DEFAULT 1,
    IpAddress NVARCHAR(50) NULL,
    UserAgent NVARCHAR(500) NULL,
    CONSTRAINT FK_Sesion_Usuario FOREIGN KEY (UsuarioId) REFERENCES dbo.Usuario(Id)
);
PRINT '   โ Tabla Sesion'

CREATE TABLE dbo.AuditoriaLog (
    Id INT IDENTITY(1,1) PRIMARY KEY,
    UsuarioId INT NULL,
    Accion NVARCHAR(100) NOT NULL,
    Tabla NVARCHAR(100) NULL,
    RegistroId INT NULL,
    Detalles NVARCHAR(MAX) NULL,
    IpAddress NVARCHAR(50) NULL,
    FechaHora DATETIME2 NOT NULL DEFAULT SYSDATETIME(),
    CONSTRAINT FK_AuditoriaLog_Usuario FOREIGN KEY (UsuarioId) REFERENCES dbo.Usuario(Id)
);
PRINT '   โ Tabla AuditoriaLog'
PRINT ''
GO

/*================================================================
  PASO 3: CREAR VISTAS Y STORED PROCEDURES
  ================================================================*/
PRINT ''
PRINT 'โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ'
PRINT '  PASO 3/7: CREANDO VISTAS Y STORED PROCEDURES'
PRINT 'โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ'
PRINT ''

-- Vista de Legajos con Detalle
CREATE OR ALTER VIEW dbo.VW_LegajoDetalle AS
SELECT
  L.Id AS LegajoId,
  N.Id AS NinoId,
  N.Dni,
  N.Apellido AS NinoApellido,
  N.Nombre AS NinoNombre,
  E.Id AS EstadoId,
  E.Nombre AS Estado,
  T.Id AS TutorId,
  T.Nombre + ' ' + ISNULL(T.Apellido, '') AS Tutor,
  L.FechaIngreso,
  L.FechaEgreso,
  L.Observaciones,
  L.UsuarioCreacion,
  L.FechaCreacion,
  L.UsuarioModificacion,
  L.FechaModificacion
FROM dbo.Legajo L
JOIN dbo.Nino N ON N.Id = L.NinoId
JOIN dbo.Estado E ON E.Id = L.EstadoId
LEFT JOIN dbo.Tutor T ON T.Id = L.TutorId;
GO
PRINT '   โ Vista VW_LegajoDetalle'

-- Vista de Alertas con Detalle
CREATE OR ALTER VIEW dbo.VW_AlertasDetalle AS
SELECT
  A.Id AS AlertaId,
  L.Id AS LegajoId,
  N.Id AS NinoId,
  (N.Nombre + ' ' + N.Apellido) AS Nino,
  TA.Nombre AS Tipo,
  P.Nombre AS Prioridad,
  EA.Nombre AS Estado,
  A.Descripcion,
  A.FechaVencimiento,
  A.UsuarioCreacion,
  A.FechaCreacion,
  A.UsuarioModificacion,
  A.FechaModificacion
FROM dbo.Alerta A
JOIN dbo.Legajo L ON L.Id = A.LegajoId
JOIN dbo.Nino N ON N.Id = L.NinoId
JOIN dbo.TipoAlerta TA ON TA.Id = A.TipoId
JOIN dbo.Prioridad P ON P.Id = A.PrioridadId
JOIN dbo.EstadoAlerta EA ON EA.Id = A.EstadoId;
GO
PRINT '   โ Vista VW_AlertasDetalle'

-- SP: Listar Alertas (Optimizado)
CREATE OR ALTER PROCEDURE dbo.SP_Alerta_GetAll
AS
BEGIN
    SET NOCOUNT ON;
    SELECT * FROM dbo.VW_AlertasDetalle WITH (NOLOCK)
    ORDER BY FechaVencimiento ASC;
END
GO
PRINT '   โ SP_Alerta_GetAll'

-- SP: Autenticar Usuario
CREATE OR ALTER PROCEDURE dbo.SP_Usuario_Autenticar
    @Usuario NVARCHAR(50),
    @PasswordHash NVARCHAR(500)
AS
BEGIN
    SET NOCOUNT ON;
    DECLARE @UsuarioId INT, @IntentosLogin INT, @Activo BIT;
    
    SELECT @UsuarioId = Id, @IntentosLogin = IntentosLogin, @Activo = Activo
    FROM dbo.Usuario WHERE Usuario = @Usuario;
    
    IF @UsuarioId IS NULL
    BEGIN
        SELECT 'error' AS Estado, 'Usuario o contraseรฑa incorrectos' AS Mensaje;
        RETURN;
    END
    
    IF @IntentosLogin >= 3 AND @Activo = 0
    BEGIN
        SELECT 'bloqueado' AS Estado, 'Usuario bloqueado' AS Mensaje;
        RETURN;
    END
    
    DECLARE @PasswordAlmacenado NVARCHAR(500);
    SELECT @PasswordAlmacenado = PasswordHash FROM dbo.Usuario WHERE Id = @UsuarioId;
    
    IF @PasswordHash = @PasswordAlmacenado
    BEGIN
        UPDATE dbo.Usuario SET IntentosLogin = 0, UltimoAcceso = SYSDATETIME(), Activo = 1 WHERE Id = @UsuarioId;
        SELECT u.Id, u.Usuario, u.Email, u.NombreCompleto, u.RolId, r.Nombre AS Rol, r.Nivel AS RolNivel, 'success' AS Estado
        FROM dbo.Usuario u INNER JOIN dbo.Rol r ON r.Id = u.RolId WHERE u.Id = @UsuarioId;
    END
    ELSE
    BEGIN
        UPDATE dbo.Usuario SET IntentosLogin = IntentosLogin + 1, UltimoIntento = SYSDATETIME(),
               Activo = CASE WHEN IntentosLogin + 1 >= 3 THEN 0 ELSE 1 END
        WHERE Id = @UsuarioId;
        SELECT 'error' AS Estado, 'Usuario o contraseรฑa incorrectos' AS Mensaje;
    END
END
GO
PRINT '   โ SP_Usuario_Autenticar'

-- SP: Crear Sesiรณn
CREATE OR ALTER PROCEDURE dbo.SP_Sesion_Crear
    @UsuarioId INT, @Token NVARCHAR(500), @DuracionMinutos INT = 30, @IpAddress NVARCHAR(50) = NULL, @UserAgent NVARCHAR(500) = NULL
AS
BEGIN
    SET NOCOUNT ON;
    UPDATE dbo.Sesion SET Activa = 0 WHERE UsuarioId = @UsuarioId AND Activa = 1;
    INSERT INTO dbo.Sesion (UsuarioId, Token, FechaExpiracion, IpAddress, UserAgent)
    VALUES (@UsuarioId, @Token, DATEADD(MINUTE, @DuracionMinutos, SYSDATETIME()), @IpAddress, @UserAgent);
    SELECT 'success' AS Estado;
END
GO
PRINT '   โ SP_Sesion_Crear'

-- SP: Validar Sesiรณn
CREATE OR ALTER PROCEDURE dbo.SP_Sesion_Validar
    @Token NVARCHAR(500)
AS
BEGIN
    SET NOCOUNT ON;
    DECLARE @SesionId INT, @UsuarioId INT, @FechaExpiracion DATETIME2, @Activa BIT;
    
    SELECT @SesionId = Id, @UsuarioId = UsuarioId, @FechaExpiracion = FechaExpiracion, @Activa = Activa
    FROM dbo.Sesion WHERE Token = @Token;
    
    IF @SesionId IS NULL OR @FechaExpiracion < SYSDATETIME() OR @Activa = 0
    BEGIN
        IF @SesionId IS NOT NULL UPDATE dbo.Sesion SET Activa = 0 WHERE Id = @SesionId;
        SELECT 'invalid' AS Estado;
        RETURN;
    END
    
    SELECT u.Id, u.Usuario, u.Email, u.NombreCompleto, u.RolId, r.Nombre AS Rol, r.Nivel AS RolNivel, 'valid' AS Estado
    FROM dbo.Usuario u INNER JOIN dbo.Rol r ON r.Id = u.RolId WHERE u.Id = @UsuarioId;
    
    UPDATE dbo.Sesion SET FechaExpiracion = DATEADD(MINUTE, 30, SYSDATETIME()) WHERE Id = @SesionId;
END
GO
PRINT '   โ SP_Sesion_Validar'

-- SP: Cerrar Sesiรณn
CREATE OR ALTER PROCEDURE dbo.SP_Sesion_Cerrar
    @Token NVARCHAR(500)
AS
BEGIN
    SET NOCOUNT ON;
    UPDATE dbo.Sesion SET Activa = 0 WHERE Token = @Token;
    SELECT 'success' AS Estado;
END
GO
PRINT '   โ SP_Sesion_Cerrar'
PRINT ''
GO

/*================================================================
  PASO 4: CREAR รNDICES OPTIMIZADOS
  ================================================================*/
PRINT ''
PRINT 'โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ'
PRINT '  PASO 4/7: CREANDO รNDICES PARA RENDIMIENTO'
PRINT 'โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ'
PRINT ''

-- รndices bรกsicos
CREATE INDEX IX_Legajo_Nino_Estado ON dbo.Legajo (NinoId, EstadoId);
CREATE INDEX IX_Alerta_Legajo_Venc ON dbo.Alerta (LegajoId, FechaVencimiento);
CREATE INDEX IX_Alerta_Estado ON dbo.Alerta (EstadoId);
PRINT '   โ รndices bรกsicos creados'

-- รndices optimizados
CREATE NONCLUSTERED INDEX IX_Nino_Dni ON Nino(Dni) INCLUDE (Nombre, Apellido, FechaNacimiento);
CREATE NONCLUSTERED INDEX IX_Tutor_Apellido_Nombre ON Tutor(Apellido, Nombre);
CREATE NONCLUSTERED INDEX IX_Legajo_NinoId ON Legajo(NinoId) INCLUDE (EstadoId, TutorId, FechaIngreso);
CREATE NONCLUSTERED INDEX IX_Legajo_EstadoId_FechaIngreso ON Legajo(EstadoId, FechaIngreso DESC);
CREATE NONCLUSTERED INDEX IX_Alerta_LegajoId ON Alerta(LegajoId) INCLUDE (TipoId, PrioridadId, EstadoId, FechaVencimiento);
CREATE NONCLUSTERED INDEX IX_Alerta_EstadoId_FechaVencimiento ON Alerta(EstadoId, FechaVencimiento);
CREATE NONCLUSTERED INDEX IX_Usuario_Email ON Usuario(Email);
CREATE NONCLUSTERED INDEX IX_Sesion_Token_Activa ON Sesion(Token, Activa);
PRINT '   โ รndices optimizados creados'
PRINT ''
GO

/*================================================================
  PASO 5: INSERTAR DATOS INICIALES
  ================================================================*/
PRINT ''
PRINT 'โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ'
PRINT '  PASO 5/7: INSERTANDO DATOS INICIALES'
PRINT 'โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ'
PRINT ''

-- Catรกlogos
INSERT INTO dbo.Estado (Nombre, Descripcion) VALUES
('Activo', 'Niรฑo alojado actualmente'),
('Egresado', 'Niรฑo dado de alta'),
('Seguimiento', 'Caso en seguimiento');
PRINT '   โ 3 estados de legajo'

INSERT INTO dbo.TipoAlerta (Nombre, Descripcion) VALUES
('Mรฉdica', 'Control mรฉdico o tratamiento'),
('Judicial', 'Trรกmite o audiencia judicial'),
('Educativa', 'Situaciรณn o reuniรณn escolar'),
('General', 'Otras alertas administrativas');
PRINT '   โ 4 tipos de alerta'

INSERT INTO dbo.Prioridad (Nombre, Color, Orden) VALUES
('Alta', '#dc3545', 1),
('Media', '#ffc107', 2),
('Baja', '#198754', 3);
PRINT '   โ 3 prioridades'

INSERT INTO dbo.EstadoAlerta (Nombre, Descripcion) VALUES
('Pendiente', 'En espera de resoluciรณn'),
('En Proceso', 'En atenciรณn'),
('Completada', 'Resuelta'),
('Cancelada', 'Cancelada');
PRINT '   โ 4 estados de alerta'

-- Roles
INSERT INTO dbo.Rol (Nombre, Descripcion, Nivel) VALUES
('Administrador', 'Acceso completo al sistema', 1),
('Operador', 'Puede crear y modificar registros', 2),
('Consultor', 'Solo lectura', 3);
PRINT '   โ 3 roles de usuario'

-- Usuario Administrador
DECLARE @AdminRolId INT = (SELECT Id FROM dbo.Rol WHERE Nombre = 'Administrador');
INSERT INTO dbo.Usuario (Usuario, PasswordHash, Salt, Email, NombreCompleto, RolId, Activo) VALUES
('admin', '1000:EQPFhZ7kGHBJq6dN8Q/Xtw==:wNLmFvKQG3YVyY6pCGt3xMR9YzUjQVPm', 'EQPFhZ7kGHBJq6dN8Q/Xtw==', 
 'admin@residencia.gob.ar', 'Administrador del Sistema', @AdminRolId, 1);
PRINT '   โ Usuario administrador creado'
PRINT ''
GO

/*================================================================
  PASO 6: INSERTAR DATOS DE DEMOSTRACIรN
  ================================================================*/
PRINT ''
PRINT 'โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ'
PRINT '  PASO 6/7: INSERTANDO DATOS DE DEMOSTRACIรN'
PRINT 'โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ'
PRINT ''

-- Tutores
INSERT INTO dbo.Tutor (Nombre, Apellido, Telefono, Email, UsuarioCreacion) VALUES
('Marรญa Soledad', 'Gonzรกlez', '11-4555-1234', 'mgonzalez@residencia.gob.ar', 'admin'),
('Carlos Alberto', 'Rodrรญguez', '11-4555-5678', 'crodriguez@residencia.gob.ar', 'admin'),
('Ana Patricia', 'Fernรกndez', '11-4555-9012', 'afernandez@residencia.gob.ar', 'admin'),
('Roberto Daniel', 'Martรญnez', '11-4555-3456', 'rmartinez@residencia.gob.ar', 'admin'),
('Laura Beatriz', 'Lรณpez', '11-4555-7890', 'llopez@residencia.gob.ar', 'admin');
PRINT '   โ 5 tutores'

-- Niรฑos
INSERT INTO dbo.Nino (Dni, Apellido, Nombre, FechaNacimiento, UsuarioCreacion) VALUES
('45123456', 'Pรฉrez', 'Juancito', '2018-03-15', 'admin'),
('45234567', 'Garcรญa', 'Sofรญa', '2017-07-22', 'admin'),
('45345678', 'Romero', 'Mateo', '2019-01-10', 'admin'),
('44123789', 'Dรญaz', 'Valentina', '2013-05-18', 'admin'),
('44234890', 'Morales', 'Thiago', '2014-09-30', 'admin'),
('44345901', 'Suรกrez', 'Catalina', '2012-11-25', 'admin'),
('43123012', 'Torres', 'Santiago', '2010-02-14', 'admin'),
('43234123', 'Ramรญrez', 'Martina', '2009-06-08', 'admin'),
('43345234', 'Flores', 'Nicolรกs', '2008-12-20', 'admin'),
('43456345', 'Castro', 'Lucรญa', '2007-04-03', 'admin');
PRINT '   โ 10 niรฑos/adolescentes'

-- Legajos
DECLARE @EstadoActivo INT = (SELECT Id FROM dbo.Estado WHERE Nombre = 'Activo');
DECLARE @EstadoSeguimiento INT = (SELECT Id FROM dbo.Estado WHERE Nombre = 'Seguimiento');

INSERT INTO dbo.Legajo (NinoId, TutorId, EstadoId, FechaIngreso, Observaciones, UsuarioCreacion) VALUES
(1, 1, @EstadoActivo, '2023-01-15', 'Ingreso por situaciรณn familiar compleja. Requiere seguimiento psicolรณgico.', 'admin'),
(2, 1, @EstadoActivo, '2023-03-20', 'Niรฑa con buen comportamiento. Asiste regularmente a la escuela.', 'admin'),
(3, 2, @EstadoActivo, '2023-05-10', 'Requiere atenciรณn mรฉdica especializada. Control mensual programado.', 'admin'),
(4, 2, @EstadoActivo, '2023-02-28', 'Adolescente en proceso de revinculaciรณn familiar.', 'admin'),
(5, 3, @EstadoActivo, '2023-04-05', 'Buen desempeรฑo acadรฉmico. Participa en actividades deportivas.', 'admin'),
(6, 3, @EstadoSeguimiento, '2022-11-15', 'Proceso judicial en curso. Audiencias mensuales.', 'admin'),
(7, 4, @EstadoActivo, '2023-06-01', 'Adolescente mayor. Prรณximo a egreso. Preparaciรณn para vida independiente.', 'admin'),
(8, 4, @EstadoActivo, '2023-01-30', 'Excelente integraciรณn al grupo. Participaciรณn activa.', 'admin'),
(9, 5, @EstadoActivo, '2022-09-20', 'Seguimiento por situaciรณn escolar. Apoyo pedagรณgico.', 'admin'),
(10, 5, @EstadoSeguimiento, '2022-08-10', 'Proceso de reunificaciรณn familiar avanzado. Visitas semanales.', 'admin');
PRINT '   โ 10 legajos'

-- Alertas
DECLARE @TipoMedica INT = (SELECT Id FROM dbo.TipoAlerta WHERE Nombre = 'Mรฉdica');
DECLARE @TipoJudicial INT = (SELECT Id FROM dbo.TipoAlerta WHERE Nombre = 'Judicial');
DECLARE @TipoEducativa INT = (SELECT Id FROM dbo.TipoAlerta WHERE Nombre = 'Educativa');
DECLARE @TipoGeneral INT = (SELECT Id FROM dbo.TipoAlerta WHERE Nombre = 'General');
DECLARE @PrioridadAlta INT = (SELECT Id FROM dbo.Prioridad WHERE Nombre = 'Alta');
DECLARE @PrioridadMedia INT = (SELECT Id FROM dbo.Prioridad WHERE Nombre = 'Media');
DECLARE @PrioridadBaja INT = (SELECT Id FROM dbo.Prioridad WHERE Nombre = 'Baja');
DECLARE @EstadoPendiente INT = (SELECT Id FROM dbo.EstadoAlerta WHERE Nombre = 'Pendiente');
DECLARE @EstadoCompletada INT = (SELECT Id FROM dbo.EstadoAlerta WHERE Nombre = 'Completada');

-- Alertas vencidas
INSERT INTO dbo.Alerta (TipoId, PrioridadId, EstadoId, LegajoId, Descripcion, FechaVencimiento, UsuarioCreacion) VALUES
(@TipoMedica, @PrioridadAlta, @EstadoPendiente, 1, 'Control pediรกtrico trimestral - Vacunaciรณn pendiente contra HPV', DATEADD(DAY, -5, CAST(GETDATE() AS DATE)), 'admin'),
(@TipoJudicial, @PrioridadAlta, @EstadoPendiente, 6, 'Audiencia judicial con Defensorรญa de Menores - Presentar informe actualizado del caso', DATEADD(DAY, -2, CAST(GETDATE() AS DATE)), 'admin'),
(@TipoEducativa, @PrioridadMedia, @EstadoPendiente, 9, 'Reuniรณn con docente por bajo rendimiento acadรฉmico - Coordinar apoyo escolar', DATEADD(DAY, -3, CAST(GETDATE() AS DATE)), 'admin');

-- Alertas que vencen hoy
INSERT INTO dbo.Alerta (TipoId, PrioridadId, EstadoId, LegajoId, Descripcion, FechaVencimiento, UsuarioCreacion) VALUES
(@TipoMedica, @PrioridadAlta, @EstadoPendiente, 3, 'ยกURGENTE! Toma de medicaciรณn programada - Control neurolรณgico a las 10:00 hs', CAST(GETDATE() AS DATE), 'admin'),
(@TipoGeneral, @PrioridadAlta, @EstadoPendiente, 7, 'Renovaciรณn de DNI - Turno en Registro Civil 14:00 hs (llevar documentaciรณn)', CAST(GETDATE() AS DATE), 'admin');

-- Alertas prรณximas (1-3 dรญas)
INSERT INTO dbo.Alerta (TipoId, PrioridadId, EstadoId, LegajoId, Descripcion, FechaVencimiento, UsuarioCreacion) VALUES
(@TipoJudicial, @PrioridadAlta, @EstadoPendiente, 4, 'Visita programada de familiar - Preparar espacio y supervisiรณn', DATEADD(DAY, 1, GETDATE()), 'admin'),
(@TipoMedica, @PrioridadMedia, @EstadoPendiente, 5, 'Control odontolรณgico semestral - Hospital Garrahan turno confirmado', DATEADD(DAY, 2, GETDATE()), 'admin'),
(@TipoEducativa, @PrioridadMedia, @EstadoPendiente, 2, 'Acto escolar - Confirmar asistencia y preparar autorizaciรณn', DATEADD(DAY, 3, GETDATE()), 'admin'),
(@TipoGeneral, @PrioridadBaja, @EstadoPendiente, 8, 'Cumpleaรฑos - Organizar festejo con el grupo', DATEADD(DAY, 3, GETDATE()), 'admin');

-- Alertas futuras (4-7 dรญas)
INSERT INTO dbo.Alerta (TipoId, PrioridadId, EstadoId, LegajoId, Descripcion, FechaVencimiento, UsuarioCreacion) VALUES
(@TipoJudicial, @PrioridadMedia, @EstadoPendiente, 10, 'Evaluaciรณn de revinculaciรณn familiar - Reuniรณn con equipo tรฉcnico', DATEADD(DAY, 5, GETDATE()), 'admin'),
(@TipoEducativa, @PrioridadBaja, @EstadoPendiente, 1, 'Entrega de boletรญn escolar - Coordinar entrevista con docente', DATEADD(DAY, 6, GETDATE()), 'admin'),
(@TipoMedica, @PrioridadMedia, @EstadoPendiente, 9, 'Control oftalmolรณgico anual - Renovaciรณn de anteojos recetados', DATEADD(DAY, 7, GETDATE()), 'admin');

-- Alertas mรกs adelante (>1 semana)
INSERT INTO dbo.Alerta (TipoId, PrioridadId, EstadoId, LegajoId, Descripcion, FechaVencimiento, UsuarioCreacion) VALUES
(@TipoMedica, @PrioridadBaja, @EstadoPendiente, 6, 'Control pediรกtrico de rutina - Chequeo general de salud', DATEADD(DAY, 15, GETDATE()), 'admin'),
(@TipoGeneral, @PrioridadBaja, @EstadoPendiente, 4, 'Actualizaciรณn de fotografรญa para expediente - Foto carnet reciente', DATEADD(DAY, 20, GETDATE()), 'admin'),
(@TipoEducativa, @PrioridadMedia, @EstadoPendiente, 7, 'Inscripciรณn a taller de arte - Confirmar cupo disponible', DATEADD(DAY, 25, GETDATE()), 'admin');

-- Alertas completadas
INSERT INTO dbo.Alerta (TipoId, PrioridadId, EstadoId, LegajoId, Descripcion, FechaVencimiento, UsuarioCreacion) VALUES
(@TipoMedica, @PrioridadAlta, @EstadoCompletada, 2, 'Vacunaciรณn COVID-19 - Segunda dosis aplicada correctamente', DATEADD(DAY, -10, GETDATE()), 'admin'),
(@TipoJudicial, @PrioridadMedia, @EstadoCompletada, 8, 'Presentaciรณn de informe mensual al juzgado - Enviado dentro del plazo', DATEADD(DAY, -15, GETDATE()), 'admin'),
(@TipoEducativa, @PrioridadBaja, @EstadoCompletada, 5, 'Reuniรณn de padres en escuela - Asistiรณ tutor asignado', DATEADD(DAY, -7, GETDATE()), 'admin'),
(@TipoGeneral, @PrioridadMedia, @EstadoCompletada, 10, 'Compra de รบtiles escolares - Material entregado completo', DATEADD(DAY, -12, GETDATE()), 'admin'),
(@TipoMedica, @PrioridadBaja, @EstadoCompletada, 3, 'Anรกlisis clรญnicos de rutina - Resultados dentro de parรกmetros normales', DATEADD(DAY, -20, GETDATE()), 'admin');
PRINT '   โ 20 alertas'
PRINT ''
GO

/*================================================================
  PASO 7: RESUMEN Y VERIFICACIรN FINAL
  ================================================================*/
PRINT ''
PRINT 'โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ'
PRINT '  PASO 7/7: RESUMEN Y VERIFICACIรN'
PRINT 'โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ'
PRINT ''

PRINT '๐ ESTADรSTICAS DE LA BASE DE DATOS:'
PRINT ''
PRINT '   ๐ฅ Tutores:              ' + CAST((SELECT COUNT(*) FROM dbo.Tutor) AS VARCHAR)
PRINT '   ๐ถ Niรฑos/Adolescentes:   ' + CAST((SELECT COUNT(*) FROM dbo.Nino) AS VARCHAR)
PRINT '   ๐ Legajos:              ' + CAST((SELECT COUNT(*) FROM dbo.Legajo) AS VARCHAR)
PRINT '   ๐ Alertas totales:      ' + CAST((SELECT COUNT(*) FROM dbo.Alerta) AS VARCHAR)
PRINT '   ๐ค Usuarios:             ' + CAST((SELECT COUNT(*) FROM dbo.Usuario) AS VARCHAR)
PRINT ''

DECLARE @Vencidas INT = (SELECT COUNT(*) FROM dbo.Alerta WHERE FechaVencimiento < CAST(GETDATE() AS DATE) AND EstadoId = (SELECT Id FROM dbo.EstadoAlerta WHERE Nombre = 'Pendiente'));
DECLARE @Proximas INT = (SELECT COUNT(*) FROM dbo.Alerta WHERE FechaVencimiento BETWEEN CAST(GETDATE() AS DATE) AND DATEADD(DAY, 3, GETDATE()) AND EstadoId = (SELECT Id FROM dbo.EstadoAlerta WHERE Nombre = 'Pendiente'));
DECLARE @Completadas INT = (SELECT COUNT(*) FROM dbo.Alerta WHERE EstadoId = (SELECT Id FROM dbo.EstadoAlerta WHERE Nombre = 'Completada'));

PRINT '   ๐ด Alertas vencidas:     ' + CAST(@Vencidas AS VARCHAR)
PRINT '   ๐ก Alertas prรณximas:     ' + CAST(@Proximas AS VARCHAR)
PRINT '   โ Alertas completadas:  ' + CAST(@Completadas AS VARCHAR)
PRINT ''

PRINT '================================================================'
PRINT '  โ INSTALACIรN COMPLETADA EXITOSAMENTE'
PRINT '================================================================'
PRINT ''
PRINT '๐ฏ SISTEMA LISTO PARA USAR'
PRINT ''
PRINT '๐ CREDENCIALES DE ACCESO:'
PRINT '   Usuario: admin'
PRINT '   Contraseรฑa: Admin123!'
PRINT '   Rol: Administrador'
PRINT ''
PRINT '๐ PRรXIMOS PASOS:'
PRINT '   1. Compilar y ejecutar el backend (WebApi) en Visual Studio (F5)'
PRINT '   2. Abrir el frontend con Live Server en VS Code'
PRINT '   3. Login en: http://localhost:5500/frontend/auth.html'
PRINT '   4. Navegar al Dashboard y verificar estadรญsticas'
PRINT ''
PRINT '๐ ESTADรSTICAS ESPERADAS EN EL DASHBOARD:'
PRINT '   Total Legajos: 10'
PRINT '   Alertas Vencidas: ~3'
PRINT '   Alertas Prรณximas: ~4-6'
PRINT '   Alertas Completadas: 5'
PRINT ''
PRINT '๐ ยกTODO LISTO PARA LA DEMOSTRACIรN!'
PRINT ''
GO

